// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  HR
  EMPLOYEE
}

enum EmploymentStatus {
  ACTIVE
  INACTIVE
  TERMINATED
  ON_LEAVE
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  LEAVE
}

enum LeaveType {
  PAID
  SICK
  UNPAID
  CASUAL
  EMERGENCY
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum PayrollStatus {
  PENDING
  PROCESSED
  PAID
}

model User {
  id            String           @id @default(uuid())
  employeeId    String           @unique
  email         String           @unique
  password      String
  firstName     String
  lastName      String
  role          Role             @default(EMPLOYEE)
  department    String?
  designation   String?
  phone         String?
  address       String?
  salary        Decimal?         @db.Decimal(10, 2)
  employmentStatus EmploymentStatus @default(ACTIVE)
  joinDate      DateTime         @default(now())
  profileImage  String?
  refreshToken  String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  // Relations
  attendances   Attendance[]
  leaveRequests LeaveRequest[]
  payrolls      Payroll[]
  activities    ActivityLog[]    @relation("UserActivities")
  decisions     LeaveRequest[]   @relation("LeaveDecisions")

  @@map("users")
}

model Attendance {
  id            String           @id @default(uuid())
  employeeId    String
  date          DateTime         @db.Date
  checkInTime   DateTime?
  checkOutTime  DateTime?
  status        AttendanceStatus @default(ABSENT)
  duration      Int?             // in minutes
  createdBy     String?
  updatedBy     String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  employee      User             @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
  @@map("attendances")
}

model LeaveRequest {
  id            String           @id @default(uuid())
  employeeId    String
  leaveType     LeaveType
  startDate     DateTime         @db.Date
  endDate       DateTime         @db.Date
  reason        String
  status        LeaveStatus      @default(PENDING)
  adminComment  String?
  decisionBy    String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  employee      User             @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  decisionMaker User?            @relation("LeaveDecisions", fields: [decisionBy], references: [id])

  @@index([employeeId])
  @@index([status])
  @@index([startDate, endDate])
  @@map("leave_requests")
}

model Payroll {
  id            String           @id @default(uuid())
  employeeId    String
  baseSalary    Decimal          @db.Decimal(10, 2)
  allowances    Decimal          @default(0) @db.Decimal(10, 2)
  deductions    Decimal          @default(0) @db.Decimal(10, 2)
  netSalary     Decimal          @db.Decimal(10, 2)
  payableMonth  DateTime         @db.Date
  status        PayrollStatus    @default(PENDING)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  employee      User             @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, payableMonth])
  @@index([employeeId])
  @@index([payableMonth])
  @@map("payrolls")
}

model ActivityLog {
  id            String           @id @default(uuid())
  userId        String
  action        String
  entityType    String
  entityId      String?
  details       Json?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime         @default(now())

  user          User             @relation("UserActivities", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("activity_logs")
}

